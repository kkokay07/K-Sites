{% extends "base.html" %}

{% block title %}Analysis Results - K-Sites{% endblock %}

{% block content %}
<div id="jobId" data-job-id="{{ job.id }}"></div>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-chart-bar me-2 text-primary"></i>Analysis Results
        </h2>
        <p class="text-muted mb-0">Job ID: <code>{{ job.id }}</code></p>
    </div>
    <div>
        <span class="status-badge status-{{ job.status }}" id="statusBadge">
            {{ job.status|upper }}
        </span>
    </div>
</div>

<!-- Loading State with Progress -->
<div id="loadingState" class="py-4" style="display: {{ 'block' if job.status in ['pending', 'running'] else 'none' }};">
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="mb-4">
                <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            
            <h4 class="text-primary mb-2">Analysis in Progress</h4>
            <p class="text-muted mb-4" id="currentStep">{{ job.current_step or 'Initializing...' }}</p>
            
            <!-- Progress Bar -->
            <div class="progress mb-3" style="height: 25px;">
                <div id="progressBar" 
                     class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {{ job.progress_percent or 0 }}%"
                     aria-valuenow="{{ job.progress_percent or 0 }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    {{ job.progress_percent or 0 }}%
                </div>
            </div>
            
            <!-- ETA -->
            <div id="etaDisplay" class="text-muted mb-4" style="display: {{ 'block' if job.estimated_completion else 'none' }};">
                <i class="fas fa-clock me-2"></i>
                Estimated completion: <span id="etaTime">{{ job.estimated_completion }}</span>
            </div>
            
            <!-- Progress Steps -->
            <div class="text-start mx-auto mt-4" style="max-width: 500px;">
                <div class="card bg-light">
                    <div class="card-header">
                        <i class="fas fa-tasks me-2"></i>Progress
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="progressSteps">
                            <li class="list-group-item d-flex justify-content-between align-items-center {{ 'list-group-item-success' if job.progress_percent >= 5 else '' }}">
                                <span><i class="fas {{ 'fa-check-circle text-success' if job.progress_percent >= 5 else 'fa-circle text-muted' }} me-2"></i>Initialize</span>
                                <span class="badge bg-secondary">5%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center {{ 'list-group-item-success' if job.progress_percent >= 15 else '' }}">
                                <span><i class="fas {{ 'fa-check-circle text-success' if job.progress_percent >= 15 else 'fa-circle text-muted' }} me-2"></i>Resolve Organism</span>
                                <span class="badge bg-secondary">15%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center {{ 'list-group-item-success' if job.progress_percent >= 30 else '' }}">
                                <span><i class="fas {{ 'fa-check-circle text-success' if job.progress_percent >= 30 else 'fa-circle text-muted' }} me-2"></i>Fetch GO Genes</span>
                                <span class="badge bg-secondary">30%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center {{ 'list-group-item-success' if job.progress_percent >= 60 else '' }}">
                                <span><i class="fas {{ 'fa-check-circle text-success' if job.progress_percent >= 60 else 'fa-circle text-muted' }} me-2"></i>Process Annotations</span>
                                <span class="badge bg-secondary">60%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center {{ 'list-group-item-success' if job.progress_percent >= 85 else '' }}">
                                <span><i class="fas {{ 'fa-check-circle text-success' if job.progress_percent >= 85 else 'fa-circle text-muted' }} me-2"></i>Generate Reports</span>
                                <span class="badge bg-secondary">85%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center {{ 'list-group-item-success' if job.progress_percent >= 100 else '' }}">
                                <span><i class="fas {{ 'fa-check-circle text-success' if job.progress_percent >= 100 else 'fa-circle text-muted' }} me-2"></i>Complete</span>
                                <span class="badge bg-secondary">100%</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Notification Info -->
            <div class="alert alert-info mt-4" style="max-width: 500px; margin: 0 auto;">
                <i class="fas fa-envelope me-2"></i>
                {% if job.user_email %}
                Results will be emailed to <strong>{{ job.user_email }}</strong> when complete.
                {% else %}
                You can leave this page and check back later. Visit <a href="/jobs">Job History</a> anytime.
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Error State -->
<div id="errorState" class="alert alert-danger" style="display: {{ 'block' if job.status == 'failed' else 'none' }};">
    <h5><i class="fas fa-times-circle me-2"></i>Analysis Failed</h5>
    <p id="errorMessage">{{ job.error_message }}</p>
    <a href="/" class="btn btn-primary">
        <i class="fas fa-arrow-left me-2"></i>Start New Analysis
    </a>
</div>

<!-- Results Content -->
<div id="resultsContent" style="display: {{ 'block' if job.status == 'completed' else 'none' }};">
    
    <!-- Success Notification -->
    <div class="alert alert-success mb-4">
        <i class="fas fa-check-circle me-2"></i>
        <strong>Analysis Complete!</strong>
        {% if job.user_email %}
        Results have been emailed to {{ job.user_email }}.
        {% endif %}
    </div>
    
    <!-- Summary Cards -->
    <div class="results-summary">
        <div class="row g-4">
            <div class="col-md-3 text-center">
                <div class="display-4 fw-bold">{{ job.total_genes_found or '-' }}</div>
                <div class="text-white-50">Total Genes Found</div>
            </div>
            <div class="col-md-3 text-center">
                <div class="display-4 fw-bold">{{ job.genes_processed or '-' }}</div>
                <div class="text-white-50">Genes Processed</div>
            </div>
            <div class="col-md-3 text-center">
                <div class="display-4 fw-bold">{{ job.total_grnas or '-' }}</div>
                <div class="text-white-50">gRNAs Designed</div>
            </div>
            <div class="col-md-3 text-center">
                <div class="display-4 fw-bold" id="avgGuidesPerGene">-</div>
                <div class="text-white-50">Avg gRNAs/Gene</div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="d-flex flex-wrap gap-2 mb-4">
        <a id="downloadHtml" class="btn btn-primary" href="#" style="display: none;">
            <i class="fas fa-file-code me-2"></i>Download HTML Report
        </a>
        <a id="downloadJson" class="btn btn-outline-primary" href="#" style="display: none;">
            <i class="fas fa-file-code me-2"></i>Download JSON
        </a>
        <button class="btn btn-outline-secondary" onclick="window.print()">
            <i class="fas fa-print me-2"></i>Print Results
        </button>
        <a href="/" class="btn btn-success">
            <i class="fas fa-plus me-2"></i>New Analysis
        </a>
    </div>
    
    <!-- Parameters Summary -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Analysis Parameters</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted">Organism:</td>
                            <td class="fw-semibold">{{ job.organism }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">TaxID:</td>
                            <td><code>{{ job.taxid }}</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted">GO Term:</td>
                            <td class="fw-semibold">{{ job.go_term }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-4">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted">GO Term Name:</td>
                            <td>{{ job.go_term_name or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Max Genes:</td>
                            <td>{{ job.max_genes }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Max Pleiotropy:</td>
                            <td>{{ job.max_pleiotropy }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-4">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td class="text-muted">Evidence Filter:</td>
                            <td>{{ job.evidence_filter }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Phenotype Prediction:</td>
                            <td>{{ 'Enabled' if job.predict_phenotypes else 'Disabled' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Databases:</td>
                            <td>{{ job.selected_databases|join(', ') if job.selected_databases else 'QuickGO' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gene Results Tabs -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="resultsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="genes-tab" data-bs-toggle="tab" data-bs-target="#genes" type="button">
                        <i class="fas fa-dna me-2"></i>Gene Results
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="guides-tab" data-bs-toggle="tab" data-bs-target="#guides" type="button">
                        <i class="fas fa-cut me-2"></i>All gRNAs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">
                        <i class="fas fa-chart-pie me-2"></i>Summary
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="resultsTabContent">
                <!-- Genes Tab -->
                <div class="tab-pane fade show active" id="genes" role="tabpanel">
                    <div id="genesContainer">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading gene results...</p>
                        </div>
                    </div>
                </div>
                
                <!-- All gRNAs Tab -->
                <div class="tab-pane fade" id="guides" role="tabpanel">
                    <div class="mb-3">
                        <input type="text" 
                               class="form-control" 
                               id="guideSearch" 
                               placeholder="Search gRNAs by sequence, gene, or score...">
                    </div>
                    <div id="guidesContainer">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading gRNA results...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Tab -->
                <div class="tab-pane fade" id="summary" role="tabpanel">
                    <div id="summaryContainer">
                        <div class="text-center py-5 text-muted">
                            <div class="spinner-border mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading summary...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- gRNA Detail Modal -->
<div class="modal fade" id="guideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">gRNA Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="guideModalContent">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/results.js') }}"></script>
{% endblock %}
