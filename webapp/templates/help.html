{% extends "base.html" %}

{% block title %}Help & Documentation - K-Sites{% endblock %}

{% block extra_css %}
<style>
.help-nav {
    position: sticky;
    top: 20px;
}
.help-nav .nav-link {
    color: #495057;
    border-left: 3px solid transparent;
    padding: 8px 16px;
}
.help-nav .nav-link:hover,
.help-nav .nav-link.active {
    color: var(--primary-color);
    border-left-color: var(--primary-color);
    background-color: #f8f9fa;
}
.term-card {
    transition: all 0.3s;
    border-left: 4px solid var(--primary-color);
}
.term-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.methodology-step {
    position: relative;
    padding-left: 60px;
    margin-bottom: 30px;
}
.methodology-step .step-icon {
    position: absolute;
    left: 0;
    top: 0;
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #1a365d 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}
.faq-item {
    border-left: 3px solid var(--secondary-color);
    padding-left: 20px;
    margin-bottom: 25px;
}
.score-visual {
    display: inline-block;
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}
.score-visual .fill {
    height: 100%;
    border-radius: 4px;
}
.score-high { background: linear-gradient(90deg, #28a745, #20c997); }
.score-medium { background: linear-gradient(90deg, #ffc107, #ff9800); }
.score-low { background: linear-gradient(90deg, #dc3545, #f44336); }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Navigation -->
    <div class="col-lg-3">
        <nav class="help-nav d-none d-lg-block">
            <h5 class="mb-3">Contents</h5>
            <nav class="nav flex-column">
                <a class="nav-link active" href="#overview">Overview</a>
                <a class="nav-link" href="#methodology">Methodology</a>
                <a class="nav-link" href="#analytical-terms">Analytical Terms</a>
                {% for key, term in analytical_terms.items() %}
                <a class="nav-link ms-3 small" href="#{{ key }}">{{ term.title }}</a>
                {% endfor %}
                <a class="nav-link" href="#faq">FAQ</a>
                <a class="nav-link" href="#neo4j-setup">Neo4j Setup</a>
            </nav>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="col-lg-9">
        <!-- Header -->
        <div class="mb-5">
            <h1 class="display-5 fw-bold text-primary">
                <i class="fas fa-book-open me-3"></i>Help & Documentation
            </h1>
            <p class="lead text-muted">Understanding K-Sites: A Comprehensive Guide</p>
        </div>
        
        <!-- Overview Section -->
        <section id="overview" class="mb-5">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-info-circle me-2"></i>What is K-Sites?</h3>
                </div>
                <div class="card-body">
                    <p class="lead">K-Sites is a comprehensive <strong>Suite for Knock-out/down Studies</strong> that integrates multiple biological databases and AI-powered analysis to design optimal CRISPR guide RNAs.</p>
                    
                    <div class="row g-4 mt-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-bullseye fa-2x text-primary me-3 mt-1"></i>
                                <div>
                                    <h5>Pathway-Aware Design</h5>
                                    <p class="text-muted mb-0">Identifies and avoids off-targets in related pathways using Neo4j graph analysis.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-brain fa-2x text-success me-3 mt-1"></i>
                                <div>
                                    <h5>AI-Powered Predictions</h5>
                                    <p class="text-muted mb-0">RAG-based phenotype prediction from scientific literature.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-filter fa-2x text-info me-3 mt-1"></i>
                                <div>
                                    <h5>Smart Filtering</h5>
                                    <p class="text-muted mb-0">Pleiotropy scoring to identify specific, safe targets.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-shield-alt fa-2x text-warning me-3 mt-1"></i>
                                <div>
                                    <h5>Safety Assessment</h5>
                                    <p class="text-muted mb-0">Comprehensive risk evaluation for each gRNA design.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Methodology Section -->
        <section id="methodology" class="mb-5">
            <h2 class="mb-4"><i class="fas fa-microscope me-2 text-primary"></i>Methodology</h2>
            
            {% for section in methodology_sections %}
            <div class="methodology-step">
                <div class="step-icon">
                    <i class="fas {{ section.icon }}"></i>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ section.title }}</h5>
                        <div class="card-text">
                            {{ section.content|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </section>
        
        <!-- Analytical Terms Section -->
        <section id="analytical-terms" class="mb-5">
            <h2 class="mb-4"><i class="fas fa-chart-bar me-2 text-primary"></i>Analytical Terms Explained</h2>
            <p class="text-muted mb-4">Understanding the scores and metrics used in K-Sites analysis reports.</p>
            
            {% for key, term in analytical_terms.items() %}
            <div id="{{ key }}" class="card term-card mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas {{ term.icon }} fa-lg text-primary me-3"></i>
                        <h4 class="card-title mb-0">{{ term.title }}</h4>
                    </div>
                    
                    <p class="lead">{{ term.short_description }}</p>
                    
                    <div class="mt-4">
                        {{ term.detailed_explanation|safe }}
                    </div>
                    
                    <div class="mt-3 text-muted small">
                        <i class="fas fa-book me-1"></i>Reference: {{ term.reference }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </section>
        
        <!-- FAQ Section -->
        <section id="faq" class="mb-5">
            <h2 class="mb-4"><i class="fas fa-question-circle me-2 text-primary"></i>Frequently Asked Questions</h2>
            
            {% for item in faq_items %}
            <div class="faq-item">
                <h5 class="text-primary">{{ item.question }}</h5>
                <p>{{ item.answer }}</p>
            </div>
            {% endfor %}
        </section>
        
        <!-- Neo4j Setup Section -->
        <section id="neo4j-setup" class="mb-5">
            <h2 class="mb-4"><i class="fas fa-database me-2 text-primary"></i>Neo4j Setup Guide</h2>
            
            <div class="card">
                <div class="card-body">
                    <h5>What is Neo4j Pathway Analysis?</h5>
                    <p>Neo4j integration enables advanced pathway-aware off-target filtering. It stores KEGG pathway relationships in a graph database, allowing K-Sites to identify when off-target genes share pathways with your target gene.</p>
                    
                    <h5 class="mt-4">Installation Steps</h5>
                    <ol>
                        <li class="mb-2">
                            <strong>Install Neo4j:</strong>
                            <pre class="bg-light p-2 rounded"><code># Using Docker
docker run -d --name neo4j-ksites -p 7687:7687 -p 7474:7474 -e NEO4J_AUTH=neo4j/password neo4j:latest

# Or download from https://neo4j.com/download/</code></pre>
                        </li>
                        <li class="mb-2">
                            <strong>Set environment variables:</strong>
                            <pre class="bg-light p-2 rounded"><code>export K_SITES_NEO4J_URI=bolt://localhost:7687
export K_SITES_NEO4J_USER=neo4j
export K_SITES_NEO4J_PASSWORD=password</code></pre>
                        </li>
                        <li class="mb-2">
                            <strong>Ingest KEGG pathway data:</strong>
                            <pre class="bg-light p-2 rounded"><code>cd /home/iiab/Documents/K-sites
python -m k_sites.neo4j.ingest_kegg --taxid 9606 --organism "Homo sapiens"</code></pre>
                        </li>
                        <li>
                            <strong>Verify connection:</strong> The Neo4j database card should show as "Available" on the analysis form.
                        </li>
                    </ol>
                    
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Neo4j is optional. K-Sites works without it using GO-based pathway analysis only.
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
});

// Update active nav link on scroll
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.help-nav .nav-link');
    
    let current = '';
    sections.forEach(section => {
        const sectionTop = section.offsetTop;
        if (pageYOffset >= sectionTop - 200) {
            current = section.getAttribute('id');
        }
    });
    
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === '#' + current) {
            link.classList.add('active');
        }
    });
});
</script>
{% endblock %}
